#!/usr/bin/env node

/**
 * Test script for Strategy Builder Engine
 * 
 * This script runs comprehensive tests for the Strategy Builder Engine including:
 * - Validation schema tests
 * - Strategy processor tests  
 * - API endpoint tests
 * - Integration tests
 */

const { execSync } = require('child_process');
const path = require('path');

console.log('ğŸ§ª Running Strategy Builder Engine Tests\n');

const testSuites = [
  {
    name: 'Validation Schema Tests',
    pattern: '__tests__/lib/validations/strategy.test.ts',
    description: 'Testing Zod validation schemas for strategy input'
  },
  {
    name: 'Strategy Processor Tests',
    pattern: '__tests__/lib/services/strategy-processor.test.ts',
    description: 'Testing strategy generation logic and rules engine'
  },
  {
    name: 'API Endpoint Tests',
    pattern: '__tests__/api/strategies.test.ts',
    description: 'Testing REST API endpoints for strategy management'
  }
];

let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function runTestSuite(suite) {
  console.log(`\nğŸ“‹ ${suite.name}`);
  console.log(`   ${suite.description}`);
  console.log('   ' + 'â”€'.repeat(50));

  try {
    const result = execSync(`npm test -- ${suite.pattern} --verbose`, {
      encoding: 'utf8',
      stdio: 'pipe'
    });

    // Parse test results
    const lines = result.split('\n');
    const testLine = lines.find(line => line.includes('Tests:'));
    
    if (testLine) {
      const matches = testLine.match(/(\d+) passed/);
      const passed = matches ? parseInt(matches[1]) : 0;
      
      const failMatches = testLine.match(/(\d+) failed/);
      const failed = failMatches ? parseInt(failMatches[1]) : 0;
      
      totalTests += passed + failed;
      passedTests += passed;
      failedTests += failed;
      
      console.log(`   âœ… ${passed} tests passed`);
      if (failed > 0) {
        console.log(`   âŒ ${failed} tests failed`);
      }
    } else {
      console.log('   âœ… All tests passed');
    }

  } catch (error) {
    console.log('   âŒ Test suite failed');
    console.log(`   Error: ${error.message}`);
    failedTests++;
  }
}

// Run all test suites
testSuites.forEach(runTestSuite);

// Summary
console.log('\n' + '='.repeat(60));
console.log('ğŸ“Š Test Summary');
console.log('='.repeat(60));
console.log(`Total Tests: ${totalTests}`);
console.log(`Passed: ${passedTests}`);
console.log(`Failed: ${failedTests}`);
console.log(`Success Rate: ${totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0}%`);

if (failedTests === 0) {
  console.log('\nğŸ‰ All tests passed! Strategy Builder Engine is ready.');
} else {
  console.log('\nâš ï¸  Some tests failed. Please review the output above.');
  process.exit(1);
}

// Additional integration test
console.log('\nğŸ”— Running Integration Test');
console.log('â”€'.repeat(30));

try {
  // Test the complete flow
  const { StrategyProcessor } = require('../src/lib/services/strategy-processor');
  const { strategyInputSchema } = require('../src/lib/validations/strategy');

  const testInput = {
    businessName: 'Integration Test Company',
    industry: 'technology',
    targetAudience: 'Small businesses looking for digital solutions',
    budget: 25000,
    objectives: ['Increase brand awareness', 'Generate leads'],
    timeframe: '6-months',
    currentChallenges: 'Limited online presence and brand recognition',
    competitorInfo: 'Competing with established tech companies',
    existingMarketing: 'Basic social media presence'
  };

  // Test validation
  const validationResult = strategyInputSchema.safeParse(testInput);
  if (!validationResult.success) {
    throw new Error('Validation failed: ' + JSON.stringify(validationResult.error.errors));
  }
  console.log('âœ… Input validation passed');

  // Test strategy generation
  StrategyProcessor.processStrategy(testInput).then(result => {
    if (!result || !result.output) {
      throw new Error('Strategy generation failed');
    }
    
    console.log('âœ… Strategy generation passed');
    console.log(`   Generated by: ${result.generatedBy}`);
    console.log(`   Executive Summary: ${result.output.executiveSummary.substring(0, 100)}...`);
    console.log(`   Marketing Channels: ${result.output.marketingChannels.length}`);
    console.log(`   Recommendations: ${result.output.recommendations.length}`);
    
    console.log('\nğŸ¯ Integration test completed successfully!');
  }).catch(error => {
    console.log('âŒ Strategy generation failed:', error.message);
    process.exit(1);
  });

} catch (error) {
  console.log('âŒ Integration test failed:', error.message);
  process.exit(1);
}

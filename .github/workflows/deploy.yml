name: Deploy to Production (Hostinger VPS)

on:
  push:
    branches: [main, release-v3]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Deploy to Hostinger VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          script: |
            set -e
            
            echo "ğŸ“ Navigating to project directory..."
            cd /opt/aureonone
            
            echo "â¬‡ï¸ Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/release-v3
            
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --prefer-offline --no-audit
            
            echo "ğŸ—„ï¸ Generating Prisma client..."
            npx prisma generate
            
            echo "ğŸ”„ Running database migrations..."
            npx prisma migrate deploy || true
            
            echo "ğŸ—ï¸ Building application..."
            NODE_OPTIONS="--max-old-space-size=4096" npm run build
            
            echo "ğŸ”„ Restarting application..."
            pm2 restart aureonone || pm2 start npm --name "aureonone" -- start
            
            echo "âœ… Deployment complete!"
            echo "ğŸ“Š Application status:"
            pm2 status aureonone

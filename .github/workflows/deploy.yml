name: Deploy to Production (Hostinger VPS)

on:
  push:
    branches: [main, release-v3]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Deploy to Hostinger VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          script: |
            set -e
            
            PROJECT_DIR="/opt/aureonone"
            REPO_URL="https://github.com/rythmscape11/creative-intelligence-platform.git"
            BRANCH="release-v3"
            
            echo "ðŸ“ Setting up project directory..."
            
            # Create directory if it doesn't exist
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ“¥ Directory doesn't exist. Creating and cloning..."
              mkdir -p /opt
              cd /opt
              git clone -b $BRANCH $REPO_URL aureonone
              cd aureonone
            else
              cd $PROJECT_DIR
              
              # Check if it's a git repository
              if [ ! -d ".git" ]; then
                echo "âš ï¸ Directory exists but not a git repo. Re-cloning..."
                cd /opt
                rm -rf aureonone
                git clone -b $BRANCH $REPO_URL aureonone
                cd aureonone
              else
                echo "â¬‡ï¸ Pulling latest changes from GitHub..."
                git fetch origin
                git reset --hard origin/$BRANCH
              fi
            fi
            
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --prefer-offline --no-audit
            
            echo "ðŸ—„ï¸ Generating Prisma client..."
            npx prisma generate
            
            echo "ðŸ”„ Running database migrations..."
            npx prisma migrate deploy || echo "âš ï¸ Migration skipped or already applied"
            
            echo "ðŸ—ï¸ Building application..."
            NODE_OPTIONS="--max-old-space-size=4096" npm run build
            
            echo "ðŸ”„ Restarting application with PM2..."
            if pm2 describe aureonone > /dev/null 2>&1; then
              pm2 restart aureonone
            else
              pm2 start npm --name "aureonone" -- start
            fi
            
            pm2 save
            
            echo "âœ… Deployment complete!"
            echo "ðŸ“Š Application status:"
            pm2 status aureonone
